<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:fire="http://schemas.microsoft.com/wix/FirewallExtension" >

	<!--
	Unattended setup: The following variable can be set:
	-  INSTALLDIR: Full path to the installation directory
	-->

	<!--
	  ====================================================================================
	  Defines & Variables
	-->

	<!-- Full version number to display. We are providing this from the command line. -->
	<!-- <?define VersionNumber="0.2.1" ?> -->

	<!--
	Upgrade code HAS to be the same for all updates.
	Once you've chosen it don't change it.
	-->
	<?define UpgradeCode="{0acc4829-4194-4aa4-acde-4afb5da49292}" ?>

	<!-- The URL for add/remove programs -->
	<?define InfoURL="https://github.com/enternoescape/opendct" ?>

	<!-- 32-bit / 64-bit variables -->
	<?if $(var.Platform) = x64 ?>
		<?define Win64 = "yes" ?>
		<?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
	<?else ?>
		<?define Win64 = "no" ?>
		<?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
	<?endif ?>

	<?define projectSourcePath = "$(var.ProjectDir)" ?>
	<?define jswSourcePath = "$(var.projectSourcePath)\jsw" ?>
	<?define configSourcePath = "$(var.projectSourcePath)\wix\config" ?>

	<!--
	====================================================================================
	Package start
	-->

	<!-- The upgrade code must never change as long as the product lives! -->
	<!-- Product IDs must be autogenerated (*) or else major upgrades will not work -->
	<Product Id="*" Name="!(loc.ApplicationName)" Language="!(loc.Language)" Version="$(var.VersionNumber)" Manufacturer="!(loc.ManufacturerFullName)" UpgradeCode="$(var.UpgradeCode)" >

	<!-- Package IDs are valid for a single package version only - they are autogenerated by WiX -->
	<!-- Let's require Windows Installer 4.0 (included in Vista) -->
	<!-- And ALWAYS install per machine!!! -->
	<Package Id="*" InstallerVersion="400" Compressed="yes" InstallScope="perMachine"  Description="!(loc.ProductDescription)" Comments="!(loc.Comments) $(var.VersionNumber)" />

	<!-- UI customization -->
	<WixVariable Id="WixUIBannerBmp" Value="images\BannerTop.bmp" />
	<WixVariable Id="WixUIDialogBmp" Value="images\Dialog.bmp" />

	<!-- Define icons (ID should not be longer than 18 chars and must end with ".exe") -->
	<Icon Id="Icon.exe" SourceFile="images\OpenDCT.ico" />

	<!-- Set properties for add/remove programs -->
	<Property Id="ARPPRODUCTICON" Value="Icon.exe" />
	<Property Id="ARPHELPLINK" Value="$(var.InfoURL)" />
	<Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />      <!-- Remove repair -->
	<Property Id="ARPNOMODIFY" Value="yes" Secure="yes" />      <!-- Remove modify -->
	<PropertyRef Id="WIX_ACCOUNT_LOCALSYSTEM" />
	<PropertyRef Id="WIX_ACCOUNT_USERS" />

	<!-- Upgrade logic -->
	<!-- AllowSameVersionUpgrades -> Always upgrade, never allow two versions to be installed next to each other -->
	<!-- AllowSameVersionUpgrades causes ICE61 which must be ignored -->
	<MajorUpgrade DowngradeErrorMessage="!(loc.NewerInstalled)" AllowSameVersionUpgrades="yes" />

	<!-- This is the main installer sequence run when the product is actually installed -->
	<InstallExecuteSequence>

		<!-- Determine the install location after the install path has been validated by the installer -->
		<Custom Action="SetARPINSTALLLOCATION" After="InstallValidate"></Custom>

	</InstallExecuteSequence>

	<!-- Set up ARPINSTALLLOCATION property (http://blogs.technet.com/b/alexshev/archive/2008/02/09/from-msi-to-wix-part-2.aspx) -->
	<CustomAction Id="SetARPINSTALLLOCATION" Property="ARPINSTALLLOCATION" Value="[INSTALLDIR]" />

	<!--
	 Launch conditions

	 1. Check minimum OS version
		If not, the installation is aborted.
		By doing the (Installed OR ...) property means that this condition will only be evaluated if the app is being installed and not on uninstall or changing

		Note: Under a Product element, a condition becomes a LaunchCondition entry.
	-->
	<Condition Message="!(loc.OS2Old)">
		<![CDATA[Installed OR (VersionNT >= 600)]]>
	</Condition>

	<!--
	 Launch conditions end
	-->
	
	<!--<CustomAction Id="FirewallExceptions" Directory="INSTALLDIR" Execute="deferred" Impersonate="no" Return='ignore'
		ExeCommand="[SystemFolder]cmd /c &quot;&quot;[INSTALLDIR]FirewallRules.cmd&quot; &quot;[#jswWrapper.exe]&quot;&quot;" />-->
	
	<!-- Save the command line value INSTALLDIR and restore it later in the sequence or it will be overwritten by the value saved to the registry during an upgrade -->
	<!-- http://robmensching.com/blog/posts/2010/5/2/the-wix-toolsets-remember-property-pattern/ -->
	<CustomAction Id='SaveCmdLineValueINSTALLDIR' Property='CMDLINE_INSTALLDIR' Value='[INSTALLDIR]' Execute='firstSequence' />
	<CustomAction Id='SetFromCmdLineValueINSTALLDIR' Property='INSTALLDIR' Value='[CMDLINE_INSTALLDIR]' Execute='firstSequence' />
	<InstallUISequence>
		<Custom Action='SaveCmdLineValueINSTALLDIR' Before='AppSearch' />
		<Custom Action='SetFromCmdLineValueINSTALLDIR' After='AppSearch'>
			CMDLINE_INSTALLDIR
		</Custom>
	</InstallUISequence>
	<InstallExecuteSequence>
		<Custom Action='SaveCmdLineValueINSTALLDIR' Before='AppSearch' />
		<Custom Action='SetFromCmdLineValueINSTALLDIR' After='AppSearch'>
			CMDLINE_INSTALLDIR
		</Custom>
		
		<!--<Custom Action="FirewallExceptions" After="InstallFiles">NOT Installed</Custom>-->
	</InstallExecuteSequence>

	<!-- Determine the directory of a previous installation (if one exists). If not INSTALLDIR stays empty -->
	<Property Id="INSTALLDIR">
		<RegistrySearch Id="DetermineInstallLocation" Type="raw" Root="HKLM" Key="Software\!(loc.ManufacturerName)\InstalledProducts\!(loc.ApplicationName)" Name="InstallLocation" />
	</Property>

	<!--
	 ====================================================================================
	 Start to build directory structure
	-->

	<!-- We do not have more than one medium (Floppy, CD, ...). Everything in one file. -->
	<Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />

	<!-- Outermost folder (kind of virtual). Fixed entry. -->
	<Directory Id="TARGETDIR" Name="SourceDir">

		<!-- We start building our directory structure here -->
		<!-- "ProgramFilesFolder" is a variable containing the absolute path. -->
		<!-- For a list of folder variables, see: http://msdn.microsoft.com/en-us/library/aa372057%28VS.85%29.aspx -->
		<Directory Id="$(var.PlatformProgramFilesFolder)">

			<!-- All folders from here on are relative to their parent. -->
			<Directory Id="ProgramFilesDCT" Name="!(loc.ManufacturerName)">

				<!-- Installation directory as a component so it can be emptied during uninstall (by default files added by someone other than Windows Installer are not removed) -->
				<Component Id="INSTALLDIR" Guid="{0acc4829-4194-4aa4-acde-4afb5da49293}">
					<CreateFolder />
					<RemoveFile Id="RemoveFilesFromAppDirectory" Name="*.*" On="uninstall" />
				</Component>

				<!-- INSTALLDIR is a property name. We need it later for the UI (to be able to change the install dir. -->
				<Directory Id="INSTALLDIR" Name="!(loc.ApplicationName)">
					<Directory Id="jswDir" Name="jsw">
						<Directory Id="jswBinDir" Name="bin">
							<Component Id="jswWrapper.exe" Guid="{0acc4829-4194-4aa4-acde-4afb5da49294}" Win64="$(var.Win64)">
								<File Source="$(var.jswSourcePath)\bin\wrapper.exe" Vital="yes" Id="jswWrapper.exe" KeyPath="yes">
                                    <fire:FirewallException Id="jswWrapper.exe.ex1" Name="OpenDCT (JSW)" Port="any" Protocol="tcp" Scope="any" IgnoreFailure="yes" />
									<fire:FirewallException Id="jswWrapper.exe.ex2" Name="OpenDCT (JSW)" Port="any" Protocol="udp" Scope="any" IgnoreFailure="yes" />
                                </File>

                                <fire:FirewallException Id="jswWrapper.exe.ex3" Name="OpenDCT (Media Server)" Port="7818" Protocol="tcp" Scope="any" IgnoreFailure="yes" />
                                <fire:FirewallException Id="jswWrapper.exe.ex4" Name="OpenDCT (SageTV Network Encoder)" Port="9000-9100" Protocol="tcp" Scope="any" IgnoreFailure="yes" />
                                <fire:FirewallException Id="jswWrapper.exe.ex5" Name="OpenDCT (SageTV Discovery)" Port="8271" Protocol="udp" Scope="any" IgnoreFailure="yes" />
                                <fire:FirewallException Id="jswWrapper.exe.ex6" Name="OpenDCT (RTP)" Port="8300-8500" Protocol="udp" Scope="any" IgnoreFailure="yes" />
                                <fire:FirewallException Id="jswWrapper.exe.ex7" Name="OpenDCT (Cling HTTP TCP)" Port="8501" Protocol="udp" Scope="any" IgnoreFailure="yes" />
                                <fire:FirewallException Id="jswWrapper.exe.ex8" Name="OpenDCT (HDHomeRun Discovery)" Port="64998" Protocol="udp" Scope="any" IgnoreFailure="yes" />

								<ServiceInstall Id="jswWrapper.exe.service" Name="opendct" DisplayName="SageTV OpenDCT" Type="ownProcess" Start="auto" Vital="yes"
									ErrorControl="normal" Description="SageTV OpenDCT Java Network Encoder for Digital Cable Tuners"
									Arguments="-s &quot;[INSTALLDIR]\jsw\conf\wrapper.conf&quot;" />
								<ServiceControl Id="jswWrapper.exe.service" Name="opendct" Wait="yes" Stop="both" Remove="uninstall"/>									
							</Component>
							<Component Id="jswStartOpenDCTNT.bat" Guid="{0acc4829-4194-4aa4-acde-4afb5da49295}" Win64="$(var.Win64)">
								<File Source="$(var.jswSourcePath)\bin\StartOpenDCT-NT.bat" Id="jswStartOpenDCTNT.bat" KeyPath="yes" Vital="yes">
									<Shortcut Id="ShortcutStartOpenDCTNT.bat"
										Directory="ProgramMenuDir"
										Advertise="yes"
										Name="OpenDCT Start Service"
										Description="Starts the OpenDCT service."
										WorkingDirectory="jswBinDir">
											<Icon Id="ShortcutStartOpenDCTNT.ico" SourceFile="$(var.rootSourcePath)\images\OpenDCT Service.ico" />
									</Shortcut>
								</File>
							</Component>
							<Component Id="jswStopOpenDCTNT.bat" Guid="{0acc4829-4194-4aa4-acde-4afb5da49296}" Win64="$(var.Win64)">
								<File Source="$(var.jswSourcePath)\bin\StopOpenDCT-NT.bat" Id="jswStopOpenDCTNT.bat" KeyPath="yes" Vital="yes">
									<Shortcut Id="ShortcutStopOpenDCTNT.bat"
										Directory="ProgramMenuDir"
										Advertise="yes"
										Name="OpenDCT Stop Service"
										Description="Starts the OpenDCT service."
										WorkingDirectory="jswBinDir">
											<Icon Id="ShortcutStopOpenDCTNT.ico" SourceFile="$(var.rootSourcePath)\images\OpenDCT Service.ico" />
									</Shortcut>
								</File>
							</Component>
							<Component Id="jswOpenDCT.bat" Guid="{0acc4829-4194-4aa4-acde-4afb5da49297}" Win64="$(var.Win64)">
								<File Source="$(var.jswSourcePath)\bin\OpenDCT.bat" Id="jswOpenDCT.bat" KeyPath="yes" Vital="yes">
									<Shortcut Id="ShortcutJswOpenDCT.bat"
										Directory="ProgramMenuDir"
										Advertise="yes"
										Name="OpenDCT Run as Console"
										Description="Runs OpenDCT in a console window. Do not run this while the service is also running."
										WorkingDirectory="jswBinDir">
											<Icon Id="ShortcutJswOpenDCT.ico" SourceFile="$(var.rootSourcePath)\images\OpenDCT Console.ico" />
									</Shortcut>
								</File>
							</Component>
						</Directory>
						<Directory Id="jswConfDir" Name="conf">
							<Component Id="jswWrapper.conf" Guid="{0acc4829-4194-4aa4-acde-4afb5da49298}">
								<File Source="$(var.jswSourcePath)\conf\wrapper.conf" Id="jswWrapper.conf" KeyPath="yes" />
							</Component>
						</Directory>
						<Directory Id="jswLibDir" Name="lib">
							<Component Id="jswWrapper.dll" Guid="{0acc4829-4194-4aa4-acde-4afb5da49299}">
								<File Source="$(var.jswSourcePath)\lib\wrapper.dll" Id="jswWrapper.dll" KeyPath="yes" />
							</Component>
							<Component Id="jswWrapper.jar" Guid="{0acc4829-4194-4aa4-acde-4afb5da4929a}">
								<File Source="$(var.jswSourcePath)\lib\wrapper.jar" Id="jswWrapper.jar" KeyPath="yes" />
							</Component>
						</Directory>
					</Directory>
				</Directory>
			</Directory>
		</Directory>

		<Directory Id="CommonAppDataFolder">
			<Component Id="CommonAppDataFolderDCT" Guid="{0acc4829-4194-4aa4-acde-4afb5da4929c}">
				<CreateFolder>
					<Permission ChangePermission="yes" GenericAll="yes" User="[WIX_ACCOUNT_LOCALSYSTEM]" />
					<Permission ChangePermission="yes" GenericAll="yes" User="[WIX_ACCOUNT_USERS]" />
				</CreateFolder>
				<RegistryValue Root="HKCU" Key="Software\!(loc.ManufacturerName)\!(loc.ApplicationName)\CommonAppDataFolderDCT" Name="installed" Type="integer" Value="1" KeyPath="yes"/>				
			</Component>
		
			<Directory Id="CommonAppDataFolderDCT" Name="OpenDCT">
				<Directory Id="CommonAppDataFolderConfig" Name="config">					
					<Component Id="configOpendct.properties" Guid="{0acc4829-4194-4aa4-acde-4afb5da4929b}" NeverOverwrite="yes" Permanent="yes">
						<File Source="$(var.configSourcePath)\opendct.properties" Id="configOpendct.properties" KeyPath="yes" Vital="yes">
							<Shortcut Id="ShortcutConfigOpendct.properties"
								Directory="ProgramMenuDir"
								Advertise="yes"
								Name="OpenDCT Properties"
								Description="Opens the OpenDCT properties file. Do not edit this file while OpenDCT is running or your changes will be overwritten."
								WorkingDirectory="jswBinDir">
									<Icon Id="ShortcutConfigOpendct.ico" SourceFile="$(var.rootSourcePath)\images\OpenDCT.ico" />
							</Shortcut>
						</File>
					</Component>
					<Directory Id="CommonAppDataFolderConfigTranscode" Name="transcode">
                        <Component Id="profileExample.properties" Guid="{0acc4829-4194-4aa4-acde-4afb5da49300}" NeverOverwrite="no" Permanent="no">
                            <File Source="$(var.configSourcePath)\transcode\profile_example.properties" Id="profileExample.properties" KeyPath="yes" Vital="yes" />
                        </Component>
                        <Component Id="ultraFast720p.properties" Guid="{0acc4829-4194-4aa4-acde-4afb5da49301}" NeverOverwrite="no" Permanent="no">
                            <File Source="$(var.configSourcePath)\transcode\ultrafast720p.properties" Id="ultraFast720p.properties" KeyPath="yes" Vital="yes" />
                        </Component>
                        <Component Id="ultraFast720p30fps.properties" Guid="{0acc4829-4194-4aa4-acde-4afb5da49302}" NeverOverwrite="no" Permanent="no">
                            <File Source="$(var.configSourcePath)\transcode\ultrafast720p30fps.properties" Id="ultraFast720p30fps.properties" KeyPath="yes" Vital="yes" />
                        </Component>
                        <Component Id="ultraFast1080p.properties" Guid="{0acc4829-4194-4aa4-acde-4afb5da49303}" NeverOverwrite="no" Permanent="no">
                            <File Source="$(var.configSourcePath)\transcode\ultrafast1080p.properties" Id="ultraFast1080p.properties" KeyPath="yes" Vital="yes" />
                        </Component>
                    </Directory>
				</Directory>
			</Directory>
		</Directory>
		
		<Directory Id="ProgramMenuFolder">
			<Component Id="ProgramMenuDir" Guid="{0acc4829-4194-4aa4-acde-4afb5da4929d}">
				<CreateFolder />
				<RemoveFolder Id='RemoveProgramMenuDir' Directory='ProgramMenuDir' On='uninstall' />
				<RegistryValue Root="HKCU" Key="Software\!(loc.ManufacturerName)\!(loc.ApplicationName)\ProgramMenuDir" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
			</Component>
			<Directory Id="ProgramMenuDir" Name="OpenDCT" />				
		</Directory>
    </Directory>
	
	<!--
	 End of directory structure
	 ====================================================================================
	-->

	<!-- Features define which parts of the application can be installed in a custom installation -->
	<Feature Id="Complete" Title="!(loc.ApplicationName)" Description="!(loc.FeatureCompleteDescription)" Display="expand" Level="1" ConfigurableDirectory="INSTALLDIR">

         <!-- A feature block for the main (GUI) program and all its dependencies -->
        <Feature Id="MainProgram" Title="!(loc.FeatureMainProgramTitle)" Description="!(loc.FeatureMainProgramDescription)" Level="1" >
			<ComponentRef Id="INSTALLDIR" />
			<ComponentRef Id="ProgramMenuDir" />
						
			<ComponentRef Id="jswWrapper.exe" />
			<ComponentRef Id="jswOpenDCT.bat" />
			<ComponentRef Id="jswStartOpenDCTNT.bat" />
			<ComponentRef Id="jswStopOpenDCTNT.bat" />
			
			<ComponentRef Id="jswWrapper.conf" />
			
			<ComponentRef Id="jswWrapper.dll" />
			<ComponentRef Id="jswWrapper.jar" />
			
			<ComponentRef Id="CommonAppDataFolderDCT" />
			<ComponentRef Id="configOpendct.properties" />
			<ComponentRef Id="profileExample.properties" />
			<ComponentRef Id="ultraFast720p.properties" />
			<ComponentRef Id="ultraFast720p30fps.properties" />
			<ComponentRef Id="ultraFast1080p.properties" />

            <!-- Generated fragment: rootComp_DCT.wxs -->
            <ComponentGroupRef Id="rootComp_DCT" />

			<!-- Generated fragment: binComp_DCT.wxs -->
			<ComponentGroupRef Id="binComp_DCT" />

			<!-- Generated fragment: jswDocComp_DCT.wxs -->
            <ComponentGroupRef Id="jswDocComp_DCT" />

        </Feature>

	</Feature>

	<UI>
		<!-- Define the installer UI -->
		<UIRef Id="WixUI_DCT" />
	</UI>

	<Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />
	</Product>
</Wix>